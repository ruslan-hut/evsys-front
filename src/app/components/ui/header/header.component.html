<mat-toolbar class="toolbar mat-elevation-z8" color="primary">
  @if (isHandset$ | async; as handset) {
    @if (handset.matches) {
      <!-- Mobile Layout: Menu | Title | Spacer | Profile -->
      @if (menuEnabled && username) {
        <button mat-icon-button [matMenuTriggerFor]="mainMenu" aria-label="Main system menu button">
          <mat-icon>menu</mat-icon>
        </button>
        <mat-menu #mainMenu="matMenu">
          <button mat-menu-item (click)="navigateTo('/points')">
            <mat-icon>ev_station</mat-icon>
            <span>Points</span>
          </button>
          @if (isAdmin) {
            <button mat-menu-item [matMenuTriggerFor]="mobileReportMenu">
              <mat-icon>assessment</mat-icon>
              <span>Report</span>
            </button>
            <mat-menu #mobileReportMenu="matMenu">
              <button mat-menu-item (click)="navigateTo('/dashboard')">Consumption chart</button>
              <button mat-menu-item (click)="navigateTo('/statistic')">Consumption</button>
              <button mat-menu-item (click)="navigateTo('/reports')">Uptime</button>
            </mat-menu>
            <button mat-menu-item (click)="navigateTo('/log/system')">
              <mat-icon>terminal</mat-icon>
              <span>System log</span>
            </button>
            <button mat-menu-item (click)="navigateTo('/log/pay')">
              <mat-icon>payment</mat-icon>
              <span>Payment log</span>
            </button>
            <button mat-menu-item (click)="navigateTo('/users')">
              <mat-icon>people</mat-icon>
              <span>Users list</span>
            </button>
            <button mat-menu-item (click)="navigateTo('/user-tags')">
              <mat-icon>sell</mat-icon>
              <span>User tags</span>
            </button>
            <button mat-menu-item (click)="navigateTo('/transactions')">
              <mat-icon>receipt</mat-icon>
              <span>Transactions</span>
            </button>
          }
          <button mat-menu-item [matMenuTriggerFor]="mobileLegalMenu">
            <mat-icon>gavel</mat-icon>
            <span>Legal</span>
          </button>
          <mat-menu #mobileLegalMenu="matMenu">
            <button mat-menu-item (click)="navigateTo('/privacy/en')">Privacy policy</button>
            <button mat-menu-item (click)="navigateTo('/terms/en')">Terms and conditions</button>
          </mat-menu>
        </mat-menu>
      }
      @if (!menuEnabled && isAdmin) {
        <button mat-icon-button (click)="navigateTo('/points')" aria-label="Back button">
          <mat-icon>arrow_back</mat-icon>
        </button>
      }

      <span>{{title}}</span>
      <span class="bar-spacer"></span>

      @if (menuEnabled && username) {
        <button mat-icon-button (click)="openUserProfile()" aria-label="View profile for {{username}}">
          <mat-icon>account_circle</mat-icon>
        </button>
      }
    } @else {
      <!-- Desktop Layout: Title | Menu | Spacer | Profile | Username | Logout -->
      @if (!menuEnabled && isAdmin) {
        <button mat-icon-button (click)="navigateTo('/points')" aria-label="Back button">
          <mat-icon>arrow_back</mat-icon>
        </button>
      }

      <span class="app-title">{{title}}</span>

      @if (menuEnabled && username) {
        <div class="desktop-menu">
          <button mat-button (click)="navigateTo('/points')">Points</button>
          @if (isAdmin) {
            <button mat-button [matMenuTriggerFor]="reportMenu">Report</button>
            <mat-menu #reportMenu="matMenu">
              <button mat-menu-item (click)="navigateTo('/dashboard')">Consumption chart</button>
              <button mat-menu-item (click)="navigateTo('/statistic')">Consumption</button>
              <button mat-menu-item (click)="navigateTo('/reports')">Uptime</button>
            </mat-menu>
            <button mat-button [matMenuTriggerFor]="adminMenu">Admin</button>
            <mat-menu #adminMenu="matMenu">
              <button mat-menu-item (click)="navigateTo('/log/system')">System log</button>
              <button mat-menu-item (click)="navigateTo('/log/pay')">Payment log</button>
              <button mat-menu-item (click)="navigateTo('/users')">Users list</button>
              <button mat-menu-item (click)="navigateTo('/user-tags')">User tags</button>
              <button mat-menu-item (click)="navigateTo('/transactions')">Transactions</button>
            </mat-menu>
          }
          <button mat-button [matMenuTriggerFor]="legalMenu">Legal</button>
          <mat-menu #legalMenu="matMenu">
            <button mat-menu-item (click)="navigateTo('/privacy/en')">Privacy policy</button>
            <button mat-menu-item (click)="navigateTo('/terms/en')">Terms and conditions</button>
          </mat-menu>
        </div>
      }

      <span class="bar-spacer"></span>

      @if (menuEnabled && username) {
        <button mat-icon-button (click)="openUserProfile()" aria-label="View profile for {{username}}">
          <mat-icon>account_circle</mat-icon>
        </button>
      }
      <span class="username-display">{{username}}</span>
      @if (username) {
        <button mat-icon-button aria-label="Log out" (click)="logout()">
          <mat-icon>logout</mat-icon>
        </button>
      } @else {
        <button mat-icon-button aria-label="Log in to your account" (click)="navigateTo('/account/login')">
          <mat-icon>account_circle</mat-icon>
        </button>
      }
    }
  }
</mat-toolbar>
