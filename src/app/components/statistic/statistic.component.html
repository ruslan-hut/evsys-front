<div class="filter-container">
  <!-- Date Range Picker -->
  <mat-form-field appearance="outline" class="date-range-field">
    <mat-label>Enter a date range</mat-label>
    <mat-date-range-input [rangePicker]="picker">
      <input matStartDate [(ngModel)]="startDate" placeholder="Start date" />
      <input matEndDate [(ngModel)]="endDate" placeholder="End date" />
    </mat-date-range-input>
    <mat-hint>MM/DD/YYYY â€“ MM/DD/YYYY</mat-hint>

    <!-- Date Picker Toggle Icon -->
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>

    <!-- Custom Dropdown Button for Predefined Ranges -->
    <button mat-icon-button matSuffix [matMenuTriggerFor]="menu">
      <mat-icon>keyboard_arrow_down</mat-icon>
    </button>

    <!-- Dropdown Menu for Predefined Ranges -->
    <mat-menu #menu="matMenu">
      @for (range of predefinedRanges; track range) {
        <button mat-menu-item (click)="setRange(range.range)">
          {{ range.label }}
        </button>
      }
    </mat-menu>

    <mat-date-range-picker #picker></mat-date-range-picker>
  </mat-form-field>




  <!-- User Role Dropdown -->
  <mat-form-field appearance="outline">
    <mat-label>Select Group</mat-label>
    <mat-select [(value)]="selectedGroup">
      @for (group of groups; track group) {
        <mat-option [value]="group.id">{{ group.name }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <!-- Data Type Dropdown -->
  <mat-form-field appearance="outline">
    <mat-label>Select Report Type</mat-label>
    <mat-select [(value)]="selectedDataType">
      <mat-option value="month">Month</mat-option>
      <mat-option value="user">User</mat-option>
      <mat-option value="charger">Charger</mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Request Data Button -->
  <button mat-raised-button color="primary" (click)="requestData()">Request Data</button>

  @if (inProgress) {
    <mat-spinner diameter="30" color="primary"></mat-spinner>
  }
</div>

<!-- Data Table -->
<mat-card>
  <table mat-table [dataSource]="displayedData">
    @if (selectedDataType === 'user' || selectedDataType === 'charger') {
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef class="center-text header-cell"> Name </th>
        <td mat-cell *matCellDef="let user" class="center-text"> {{ user.user }} </td>
        <td mat-footer-cell *matFooterCellDef class="center-text footer-cell">Total</td>
      </ng-container>
    }

    @if (selectedDataType === 'user' || selectedDataType === 'charger') {
      <ng-container matColumnDef="userCount">
        <th mat-header-cell *matHeaderCellDef class="center-text header-cell" > Count </th>
        <td mat-cell *matCellDef="let user" class="center-text"> {{ user.count }} </td>
        <td mat-footer-cell *matFooterCellDef class="center-text footer-cell"> {{ totalUserCount }} </td>
      </ng-container>
    }

    @if (selectedDataType === 'user' || selectedDataType === 'charger') {
      <ng-container matColumnDef="userWatts">
        <th mat-header-cell *matHeaderCellDef class="center-text header-cell"> kWatts </th>
        <td mat-cell *matCellDef="let user" class="center-text"> {{ (user.total / 1000) | number:'1.1-1' }} </td>
        <td mat-footer-cell *matFooterCellDef class="center-text footer-cell"> {{ (totalUserWatts  / 1000) | number:'1.1-1' }} </td>
      </ng-container>
    }

    @if (selectedDataType === 'user' || selectedDataType === 'charger') {
      <ng-container matColumnDef="userAvgWatts">
        <th mat-header-cell *matHeaderCellDef class="center-text header-cell"> Avg kWatts </th>
        <td mat-cell *matCellDef="let user" class="center-text"> {{ (user.average / 1000) | number:'1.1-1' }} </td>
        <td mat-footer-cell *matFooterCellDef class="center-text footer-cell"> {{ (avgUserWatts / 1000) | number:'1.1-1' }} </td>
      </ng-container>
    }

    <!-- Columns for 'month' data type -->
    @if (selectedDataType === 'month') {
      <ng-container matColumnDef="year">
        <th mat-header-cell *matHeaderCellDef class="center-text header-cell"> Year </th>
        <td mat-cell *matCellDef="let month" class="center-text"> {{ month.year }} </td>
        <td mat-footer-cell *matFooterCellDef class="center-text footer-cell"> Total </td>
      </ng-container>
    }

    @if (selectedDataType === 'month') {
      <ng-container matColumnDef="month">
        <th mat-header-cell *matHeaderCellDef class="center-text header-cell"> Month </th>
        <td mat-cell *matCellDef="let month" class="center-text"> {{ month.month }} </td>
        <td mat-footer-cell *matFooterCellDef class="center-text footer-cell"> </td>
      </ng-container>
    }

    @if (selectedDataType === 'month') {
      <ng-container matColumnDef="count">
        <th mat-header-cell *matHeaderCellDef class="center-text header-cell"> Count </th>
        <td mat-cell *matCellDef="let month" class="center-text"> {{ month.count }} </td>
        <td mat-footer-cell *matFooterCellDef class="center-text footer-cell"> {{ totalMonthCount }} </td>
      </ng-container>
    }

    @if (selectedDataType === 'month') {
      <ng-container matColumnDef="watts">
        <th mat-header-cell *matHeaderCellDef class="center-text header-cell"> kWatts </th>
        <td mat-cell *matCellDef="let month" class="center-text"> {{ (month.total / 1000) | number:'1.1-1' }} </td>
        <td mat-footer-cell *matFooterCellDef class="center-text footer-cell"> {{ (totalMonthWatts / 1000) | number:'1.1-1' }} </td>
      </ng-container>
    }

    @if (selectedDataType === 'month') {
      <ng-container matColumnDef="avgWatts">
        <th mat-header-cell *matHeaderCellDef class="center-text header-cell"> Avg kWatts </th>
        <td mat-cell *matCellDef="let month" class="center-text"> {{ (month.average / 1000) | number:'1.1-1' }} </td>
        <td mat-footer-cell *matFooterCellDef class="center-text footer-cell"> {{ (avgMonthWatts / 1000) | number:'1.1-1' }} </td>
      </ng-container>
    }

    <!-- Table Rows -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    <tr mat-footer-row *matFooterRowDef="displayedColumns"></tr>
  </table>
</mat-card>

