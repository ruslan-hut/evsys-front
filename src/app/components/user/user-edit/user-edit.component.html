@if (loading) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
}

<div class="user-edit-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title class="title-with-action">
        @if (isEditMode) {
          <span>Edit User: {{ username }}</span>
          <button mat-icon-button (click)="copyUsername()" aria-label="Copy username" class="copy-button">
            <mat-icon>content_copy</mat-icon>
          </button>
        } @else {
          Create New User
        }
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="user-form">
        @if (!isEditMode) {
          <mat-form-field appearance="outline">
            <mat-label>Username</mat-label>
            <input matInput formControlName="username" placeholder="Enter username">
            @if (form.get('username')?.hasError('required')) {
              <mat-error>Username is required</mat-error>
            }
            @if (form.get('username')?.hasError('minlength')) {
              <mat-error>Username must be at least 3 characters</mat-error>
            }
          </mat-form-field>
        }

        <mat-form-field appearance="outline">
          <mat-label>Password</mat-label>
          <input matInput type="password" formControlName="password" placeholder="Enter password">
          @if (form.get('password')?.hasError('minlength')) {
            <mat-error>Password must be at least 6 characters</mat-error>
          }
          @if (isEditMode) {
            <mat-hint>Leave empty to keep current password</mat-hint>
          } @else {
            <mat-hint>Required for new users</mat-hint>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Full Name</mat-label>
          <input matInput formControlName="name" placeholder="First Last">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Email</mat-label>
          <input matInput type="email" formControlName="email" placeholder="user@example.com">
          @if (form.get('email')?.hasError('email')) {
            <mat-error>Please enter a valid email</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Role</mat-label>
          <mat-select formControlName="role">
            @for (role of roles; track role.value) {
              <mat-option [value]="role.value">{{ role.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Access Level</mat-label>
          <input matInput type="number" formControlName="access_level" min="0" max="10">
          <mat-hint>0-10</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Payment Plan</mat-label>
          <input matInput formControlName="payment_plan" placeholder="Plan ID">
        </mat-form-field>

        @if (isEditMode && user) {
          <div class="readonly-info">
            @if (user.date_registered) {
              <p><strong>Registered:</strong> {{ user.date_registered }}</p>
            }
            @if (user.last_seen) {
              <p><strong>Last Seen:</strong> {{ user.last_seen }}</p>
            }
          </div>
        }
      </form>
    </mat-card-content>

    <mat-card-actions>
      @if (isEditMode) {
        <button mat-button type="button" (click)="openUserTags()">
          User Tags
        </button>
      }
      <span class="actions-spacer"></span>
      <button mat-button type="button" (click)="navigateBack()">
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>
      <button mat-raised-button color="primary"
              (click)="onSubmit()"
              [disabled]="saving || form.invalid">
        @if (saving) {
          Saving...
        } @else if (isEditMode) {
          Update User
        } @else {
          Create User
        }
      </button>
    </mat-card-actions>

    @if (saving) {
      <mat-card-footer>
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </mat-card-footer>
    }
  </mat-card>
</div>
