@if (loading) {
  <div><mat-progress-bar mode="indeterminate"></mat-progress-bar></div>
}

<!-- Desktop: always visible filter container -->
<div class="filter-container desktop-only">
  <mat-form-field appearance="outline" class="date-range-field">
    <mat-label>Date Range</mat-label>
    <mat-date-range-input [rangePicker]="pickerDesktop">
      <input matStartDate [(ngModel)]="startDate" placeholder="Start" />
      <input matEndDate [(ngModel)]="endDate" placeholder="End" />
    </mat-date-range-input>
    <mat-hint>MM/DD/YYYY - MM/DD/YYYY</mat-hint>
    <mat-datepicker-toggle matSuffix [for]="pickerDesktop"></mat-datepicker-toggle>
    <button mat-icon-button matSuffix [matMenuTriggerFor]="rangeMenuDesktop" aria-label="Select predefined range">
      <mat-icon>keyboard_arrow_down</mat-icon>
    </button>
    <mat-menu #rangeMenuDesktop="matMenu">
      @for (range of predefinedRanges; track range.label) {
        <button mat-menu-item (click)="setRange(range.range)">{{ range.label }}</button>
      }
    </mat-menu>
    <mat-date-range-picker #pickerDesktop></mat-date-range-picker>
  </mat-form-field>

  <mat-form-field appearance="outline" class="station-select-field">
    <mat-label>Station</mat-label>
    <mat-select [(ngModel)]="selectedStation">
      <mat-option value="">All Stations</mat-option>
      @for (cp of chargePoints; track cp.id) {
        <mat-option [value]="cp.id">{{ cp.title }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <button mat-raised-button color="primary" (click)="loadData()" [disabled]="loading">
    <mat-icon>refresh</mat-icon>
    Load Data
  </button>
</div>

<!-- Mobile: collapsible filter panel -->
<mat-expansion-panel class="filter-panel mobile-only" [expanded]="false">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <mat-icon>filter_list</mat-icon>
      Filters
    </mat-panel-title>
  </mat-expansion-panel-header>

  <div class="filter-container">
    <mat-form-field appearance="outline" class="date-range-field">
      <mat-label>Date Range</mat-label>
      <mat-date-range-input [rangePicker]="pickerMobile">
        <input matStartDate [(ngModel)]="startDate" placeholder="Start" />
        <input matEndDate [(ngModel)]="endDate" placeholder="End" />
      </mat-date-range-input>
      <mat-hint>MM/DD/YYYY - MM/DD/YYYY</mat-hint>
      <mat-datepicker-toggle matSuffix [for]="pickerMobile"></mat-datepicker-toggle>
      <button mat-icon-button matSuffix [matMenuTriggerFor]="rangeMenuMobile" aria-label="Select predefined range">
        <mat-icon>keyboard_arrow_down</mat-icon>
      </button>
      <mat-menu #rangeMenuMobile="matMenu">
        @for (range of predefinedRanges; track range.label) {
          <button mat-menu-item (click)="setRange(range.range)">{{ range.label }}</button>
        }
      </mat-menu>
      <mat-date-range-picker #pickerMobile></mat-date-range-picker>
    </mat-form-field>

    <mat-form-field appearance="outline" class="station-select-field">
      <mat-label>Station</mat-label>
      <mat-select [(ngModel)]="selectedStation">
        <mat-option value="">All Stations</mat-option>
        @for (cp of chargePoints; track cp.id) {
          <mat-option [value]="cp.id">{{ cp.title }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <button mat-raised-button color="primary" (click)="loadData()" [disabled]="loading">
      <mat-icon>refresh</mat-icon>
      Load Data
    </button>
  </div>
</mat-expansion-panel>

<div class="current-period">
  <span class="period-label">Period:</span>
  <span class="period-value">{{ startDate | date:'mediumDate' }} â€” {{ endDate | date:'mediumDate' }}</span>
</div>

<div class="tab-content">
  <div class="summary-cards">
    <mat-card class="summary-card" [class]="getUptimeClass(averageUptime)">
      <mat-card-content>
        <div class="summary-value">{{ averageUptime | number:'1.1-1' }}%</div>
        <div class="summary-label">Average Uptime</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card total">
      <mat-card-content>
        <div class="summary-value">{{ stationsAnalyzed }}</div>
        <div class="summary-label">Stations</div>
      </mat-card-content>
    </mat-card>
  </div>

  @if (chartData.length > 0) {
    <div class="charts-grid">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Uptime by Station</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <ngx-charts-bar-horizontal
              [results]="chartData"
              [xAxisLabel]="'Uptime %'"
              [yAxisLabel]="'Station'"
              [showXAxisLabel]="true"
              [showYAxisLabel]="true"
              [xAxis]="true"
              [yAxis]="true"
              [scheme]="colorScheme"
              [xScaleMax]="100"
              [gradient]="true">
            </ngx-charts-bar-horizontal>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  }

  @if (!loading && stations.length === 0) {
    <div class="no-data">No uptime data available for the selected period</div>
  }

  @if (stations.length > 0) {
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Station Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- Desktop: Table -->
        <div class="table-responsive desktop-only">
          <table mat-table [dataSource]="stations" matSort>
            <ng-container matColumnDef="charge_point_id">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Station ID</th>
              <td mat-cell *matCellDef="let station" class="station-id-cell">{{ station.charge_point_id }}</td>
            </ng-container>

            <ng-container matColumnDef="online_duration">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Online</th>
              <td mat-cell *matCellDef="let station">{{ formatDuration(station.online_minutes) }}</td>
            </ng-container>

            <ng-container matColumnDef="offline_duration">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Offline</th>
              <td mat-cell *matCellDef="let station">{{ formatDuration(station.offline_minutes) }}</td>
            </ng-container>

            <ng-container matColumnDef="uptime_percent">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Uptime</th>
              <td mat-cell *matCellDef="let station">
                <span class="uptime-badge" [class]="getUptimeClass(station.uptime_percent)">
                  {{ station.uptime_percent | number:'1.1-1' }}%
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="final_state">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Final State</th>
              <td mat-cell *matCellDef="let station">
                <span class="state-badge" [class]="getStateClass(station.final_state)">{{ station.final_state }}</span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            <tr class="mat-row" *matNoDataRow>
              <td class="mat-cell no-data-cell" [attr.colspan]="displayedColumns.length">
                No data available
              </td>
            </tr>
          </table>
        </div>

        <!-- Mobile: Expansion Panels -->
        <div class="mobile-list mobile-only">
          @for (station of stations; track station.charge_point_id) {
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>{{ station.charge_point_id }}</mat-panel-title>
                <mat-panel-description>
                  <span class="uptime-badge" [class]="getUptimeClass(station.uptime_percent)">
                    {{ station.uptime_percent | number:'1.1-1' }}%
                  </span>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <div class="panel-content">
                <div class="detail-row">
                  <span class="detail-label">Online:</span>
                  <span class="detail-value">{{ formatDuration(station.online_minutes) }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Offline:</span>
                  <span class="detail-value">{{ formatDuration(station.offline_minutes) }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Final State:</span>
                  <span class="state-badge" [class]="getStateClass(station.final_state)">{{ station.final_state }}</span>
                </div>
              </div>
            </mat-expansion-panel>
          }
        </div>
      </mat-card-content>
    </mat-card>
  }
</div>
