@if (loading) {
  <div><mat-progress-bar mode="indeterminate"></mat-progress-bar></div>
}

<div class="transactions-container">
  <!-- Filter Section - Mobile (Collapsible) -->
  @if (isMobile$ | async) {
    <mat-expansion-panel class="filter-panel">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>filter_list</mat-icon>
          Filters
        </mat-panel-title>
        <mat-panel-description>
          @if (hasActiveFilters()) {
            {{ getActiveFiltersCount() }} active
          }
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div class="filter-container mobile">
        <mat-form-field appearance="outline" class="date-range-field">
          <mat-label>Date Range</mat-label>
          <mat-date-range-input [rangePicker]="pickerMobile">
            <input matStartDate [(ngModel)]="startDate" placeholder="Start date">
            <input matEndDate [(ngModel)]="endDate" placeholder="End date">
          </mat-date-range-input>
          <mat-datepicker-toggle matSuffix [for]="pickerMobile"></mat-datepicker-toggle>
          <button mat-icon-button matSuffix [matMenuTriggerFor]="dateMenuMobile"
                  aria-label="Select predefined date range">
            <mat-icon>keyboard_arrow_down</mat-icon>
          </button>
          <mat-menu #dateMenuMobile="matMenu">
            @for (range of predefinedRanges; track range.label) {
              <button mat-menu-item (click)="setRange(range.range)">
                {{ range.label }}
              </button>
            }
          </mat-menu>
          <mat-date-range-picker #pickerMobile></mat-date-range-picker>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Username</mat-label>
          <input matInput [(ngModel)]="usernameFilter" placeholder="Filter by username">
          @if (usernameFilter) {
            <button matSuffix mat-icon-button class="filter-clear-btn" (click)="usernameFilter = ''" aria-label="Clear username filter">
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>ID Tag</mat-label>
          <input matInput [(ngModel)]="idTagFilter" placeholder="Filter by ID tag">
          @if (idTagFilter) {
            <button matSuffix mat-icon-button class="filter-clear-btn" (click)="idTagFilter = ''" aria-label="Clear ID tag filter">
              <mat-icon>close</mat-icon>
            </button>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Charge Point</mat-label>
          <mat-select [(value)]="chargePointFilter">
            <mat-option value="">All</mat-option>
            @for (cp of chargePoints; track cp.charge_point_id) {
              <mat-option [value]="cp.charge_point_id">
                {{ cp.title || cp.charge_point_id }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <div class="filter-actions">
          <button mat-raised-button color="primary" (click)="loadTransactions()">
            <mat-icon>search</mat-icon>
            Search
          </button>
          <button mat-button (click)="clearFilters()">
            <mat-icon>clear</mat-icon>
            Clear
          </button>
        </div>
      </div>
    </mat-expansion-panel>
  } @else {
    <!-- Filter Section - Desktop -->
    <div class="filter-container">
      <mat-form-field appearance="outline" class="date-range-field">
        <mat-label>Date Range</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input matStartDate [(ngModel)]="startDate" placeholder="Start date">
          <input matEndDate [(ngModel)]="endDate" placeholder="End date">
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <button mat-icon-button matSuffix [matMenuTriggerFor]="dateMenu"
                aria-label="Select predefined date range">
          <mat-icon>keyboard_arrow_down</mat-icon>
        </button>
        <mat-menu #dateMenu="matMenu">
          @for (range of predefinedRanges; track range.label) {
            <button mat-menu-item (click)="setRange(range.range)">
              {{ range.label }}
            </button>
          }
        </mat-menu>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Username</mat-label>
        <input matInput [(ngModel)]="usernameFilter" placeholder="Filter by username">
        @if (usernameFilter) {
          <button matSuffix mat-icon-button class="filter-clear-btn" (click)="usernameFilter = ''" aria-label="Clear username filter">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>ID Tag</mat-label>
        <input matInput [(ngModel)]="idTagFilter" placeholder="Filter by ID tag">
        @if (idTagFilter) {
          <button matSuffix mat-icon-button (click)="idTagFilter = ''" aria-label="Clear ID tag filter">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Charge Point</mat-label>
        <mat-select [(value)]="chargePointFilter">
          <mat-option value="">All</mat-option>
          @for (cp of chargePoints; track cp.charge_point_id) {
            <mat-option [value]="cp.charge_point_id">
              {{ cp.title || cp.charge_point_id }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>

      <div class="filter-actions">
        <button mat-raised-button color="primary" (click)="loadTransactions()">
          <mat-icon>search</mat-icon>
          Search
        </button>
        <button mat-button (click)="clearFilters()">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
      </div>
    </div>
  }

  <!-- Summary -->
  @if (dataSource.filteredData.length > 0) {
    <div class="transactions-summary">
      <span class="summary-label">Total consumed:</span>
      <span class="summary-value">{{ totalConsumedKWh | number:'1.2-2' }} kWh</span>
      <span class="summary-count">({{ dataSource.filteredData.length }} transactions)</span>
    </div>
  }

  <!-- Mobile Card Layout -->
  @if (isMobile$ | async) {
    <mat-accordion class="transaction-accordion">
      @for (row of paginatedData; track row.transaction_id) {
        <mat-expansion-panel class="transaction-panel">
          <mat-expansion-panel-header>
            <mat-panel-title class="transaction-panel-title">
              <span class="transaction-id">#{{ row.transaction_id }}</span>
              <span class="consumed-value">{{ getConsumed(row) / 1000 | number:'1.2-2' }} kWh</span>
            </mat-panel-title>
            <mat-panel-description class="transaction-panel-description">
              {{ formatDateTime(row.time_start) }}
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="transaction-details">
            <div class="detail-row">
              <span class="detail-label">ID Tag:</span>
              <span class="detail-value">{{ row.id_tag }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Charge Point:</span>
              <span class="detail-value">{{ row.charge_point_id }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Connector:</span>
              <span class="detail-value">{{ row.connector_id }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Started:</span>
              <span class="detail-value">{{ formatDateTime(row.time_start) }}</span>
            </div>
            @if (row.time_stop) {
              <div class="detail-row">
                <span class="detail-label">Stopped:</span>
                <span class="detail-value">{{ formatDateTime(row.time_stop) }}</span>
              </div>
            }
            <div class="detail-row">
              <span class="detail-label">Consumed:</span>
              <span class="detail-value">{{ getConsumed(row) / 1000 | number:'1.2-2' }} kWh</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Amount:</span>
              <span class="detail-value">
                @if (row.payment_amount) {
                  {{ formatAmount(row.payment_amount) }} EUR
                } @else {
                  -
                }
              </span>
            </div>
            <div class="transaction-actions">
              <button mat-icon-button class="list-action-btn" (click)="viewDetails(row.transaction_id)"
                      matTooltip="View details">
                <mat-icon>visibility</mat-icon>
              </button>
            </div>
          </div>
        </mat-expansion-panel>
      } @empty {
        <div class="no-data">No transactions found</div>
      }
    </mat-accordion>

    <mat-paginator
      #transactionPaginator
      [pageSizeOptions]="[10, 25, 50]"
      [showFirstLastButtons]="false"
      aria-label="Select page of transactions">
    </mat-paginator>
  } @else {
    <!-- Desktop Table Layout -->
    <div class="mat-elevation-z8">
      <div class="table-responsive">
        <table mat-table matSort [dataSource]="dataSource">
          <!-- Transaction ID Column -->
          <ng-container matColumnDef="transaction_id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
            <td mat-cell *matCellDef="let row">{{ row.transaction_id }}</td>
          </ng-container>

          <!-- ID Tag Column -->
          <ng-container matColumnDef="id_tag">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>ID Tag</th>
            <td mat-cell *matCellDef="let row">{{ row.id_tag }}</td>
          </ng-container>

          <!-- Charge Point Column -->
          <ng-container matColumnDef="charge_point_id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Charge Point</th>
            <td mat-cell *matCellDef="let row">{{ row.charge_point_id }}</td>
          </ng-container>

          <!-- Connector Column -->
          <ng-container matColumnDef="connector_id">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Connector</th>
            <td mat-cell *matCellDef="let row">{{ row.connector_id }}</td>
          </ng-container>

          <!-- Time Start Column -->
          <ng-container matColumnDef="time_start">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Started</th>
            <td mat-cell *matCellDef="let row">{{ row.time_start | date:'short' }}</td>
          </ng-container>

          <!-- Time Stop Column -->
          <ng-container matColumnDef="time_stop">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Stopped</th>
            <td mat-cell *matCellDef="let row">
              {{ row.time_stop ? (row.time_stop | date:'short') : '-' }}
            </td>
          </ng-container>

          <!-- Consumed Column -->
          <ng-container matColumnDef="consumed">
            <th mat-header-cell *matHeaderCellDef>Consumed</th>
            <td mat-cell *matCellDef="let row">
              {{ getConsumed(row) / 1000 | number:'1.2-2' }} kWh
            </td>
          </ng-container>

          <!-- Payment Amount Column -->
          <ng-container matColumnDef="payment_amount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
            <td mat-cell *matCellDef="let row">
              @if (row.payment_amount) {
                {{ formatAmount(row.payment_amount) }}
              } @else {
                -
              }
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let row">
              <button mat-icon-button class="list-action-btn" (click)="viewDetails(row.transaction_id)"
                      matTooltip="View details">
                <mat-icon>visibility</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>

          <tr *matNoDataRow>
            <td class="mat-cell" colspan="10">No transactions found</td>
          </tr>
        </table>
      </div>

      <mat-paginator
        #transactionPaginator
        [pageSizeOptions]="[10, 50, 100]"
        [showFirstLastButtons]="showFirstLastButtons"
        aria-label="Select page of transactions">
      </mat-paginator>
    </div>
  }
</div>
